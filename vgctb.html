<!DOCTYPE html>
<html>
	<head>

		<title>Team Battles</title>
		<meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<link href='https://fonts.googleapis.com/css?family=Faster+One' rel='stylesheet' type='text/css'>
		<link href="https://fonts.googleapis.com/css?family=Righteous" rel="stylesheet">
		<style>

			body {
				background-color: rgba(0, 0, 0, 0);
				overflow: hidden;
				transition: background-color 2s;
			}
			body.selectTv {
				background-color: rgba(0, 0, 0, 0.7);
			}
			
			#next {
				position: absolute;
				top: 730px;
			}
			
			#frame {
				background-image: url("playericons/controllers/tb box.png");
				background-size: auto;
				background-position: center;
				background-repeat: no-repeat;
				width: 1058px;
				height: 70px;
				position: absolute;
				top: 592px;
				left: 111px;
			}

			#description {
				color: #dddddd;
				text-shadow: 2px 2px 2px #000000;
				font-size: 13px;
				font-family: Verdana;
				height: 20px;
				padding-top: 2px;
				background-color: rgba(0, 0, 0, .0);
			}
			#header {
				display: table;
				width: 903px;
				padding: 0px 5px;
			}
			#header > div {
				display: table-cell;
			}

			#challenge-details {
				position: absolute;
				top: 31px;
				padding: 16px 5px 3px 5px;
				height: auto;
				width: 910px;
				transform: translateY(-40%);
			}

			#challenge {
				font-weight: bold;
				padding-left: 15px;
			}
			#game-console {
				font-weight: bold;
				padding-left: 15px;
			}
			#game-name {
				font-weight: bold;
				color: magenta;
				width: 100%;
			}
			#by-heading {
				font-weight: bold;
				color: pink;
				padding-left: 15px;
			}
			#submitter {
				padding-left: 5px;
				white-space: nowrap;
			}
			#state-heading {
				font-weight: bold;
				color: pink;
				padding-left: 15px;
			}
			#state-slot {
				padding-left: 5px;
			}

			#description {
				position: absolute;
				top: 3px;
				left: 73px;
				width: 913px;
				height: 63px;
				background-color: rgba(0, 0, 0, .85);
				
				transition-property: opacity;
				transition-duration: 0.5s;
			}
			
			#controllerA, #controllerB {
				position: absolute;
				top: 4px;
				width: 65px;
				height: 62px;
				background-size: cover;
			}
			#controllerA {
				left: 4px;
			}
			#controllerB {
				left: 989px;
			}
			.controllerNES {
				background: url('playericons/controllers/nes_controller.png'), linear-gradient(to bottom, red 0%, white 50%, red 100%);
			}
			.controllerSNES {
				background: url('playericons/controllers/snes_controller.png'), linear-gradient(to bottom, green 0%, white 50%, green 100%);
			}
			.controllerGBA {
				background: url('playericons/controllers/gba_controller.png'), linear-gradient(to bottom, blue 0%, white 50%, blue 100%);
			}
			.controllerN64 {
				background: url('playericons/controllers/64_controller.png'), linear-gradient(to bottom, purple 0%, white 50%, purple 100%);
			}
			.controllerGEN {
				background: url('playericons/controllers/genesis_controller.png'), linear-gradient(to bottom, orange 0%, white 50%, orange 100%);
			}

			#frame, #game-list {
				transition-property: opacity, visibility, top;
				transition-duration: 0.5s;
			}
			#game-list {
				transition-duration: 2s;
			}
			#game-list.hidden {
				opacity: 0;
				visibility: hidden;
			}
			#frame.hidden {
				top: 1080px;
			}
			
			#game-list {
				width: 1280px;
				height: 327px;
				position: absolute;
				top: 360px;
				left: 0;
				transform: translateY(-50%);
				background-image: url('TV bank.png');
				backface-visibility: hidden;
			}
			#game-list > button {
				position: absolute;
				top: 34px;
				width: 264px;
				height: 232px;
				color: transparent;
				cursor: pointer;
				outline: none;
				border: none;
			}
			#game-0 {
				left: 35px;
			}
			#game-1 {
				left: 463px;
			}
			#game-2 {
				left: 888px;
			}
			
			#game-0-overlay, #game-1-overlay, #game-2-overlay {
				background: url('TV on.png') no-repeat;
				position: absolute;
				top: 26px;
				width: 280px;
				height: 244px;
				pointer-events: none;
			}
			#game-0-overlay {
				left: 27px;
			}
			#game-1-overlay {
				left: 455px;
			}
			#game-2-overlay {
				left: 880px;
			}
			.load-failed {
				background-image: url('tv-test.png');
				background-repeat: no-repeat;
				background-size: cover;
			}
			
			#game-0-name, #game-1-name, #game-2-name {
				position: absolute;
				display: inline-block;
				top: 294px;
				left: 45px;
				width: 280px;
				font-family: Righteous;
				font-size: 18px;
				color: #a2dae9;
				text-shadow: 3px 3px 0px #000000;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			#game-1-name {
				left: 473px;
			}
			#game-2-name {
				left: 898px;
			}
			
			#game-0-console, #game-1-console, #game-2-console {
				position: absolute;
				display: inline-block;
				top: 296px;
				left: 335px;
				font-family: Righteous;
				font-size: 16px;
				color: #a2dae9;
				text-shadow: 3px 3px 0px #000000;
			}
			#game-1-console {
				left: 763px;
			}
			#game-2-console {
				left: 1188px;
			}
			
			#game-0-channel, #game-1-channel, #game-2-channel {
				position: absolute;
				top: 32px;
				left: 335px;
				font-family: "Faster One";
				font-size: 36px;
				color: palegreen;
			}
			#game-1-channel {
				left: 763px;
			}
			#game-2-channel {
				left: 1188px;
			}
			</style>
	</head>
	<body>
		<audio id="ding">
			<source src="Ding.mp3" type="audio/mpeg">
		</audio>

		<div id="frame" class="hidden">
			<div id="controllerA"></div>
			<div id="description">
				<div id="header">
					<div id="game-name">Game</div>

					<div id="game-console"></div>
					<div id="challenge">TB#</div>

					<div id="by-heading">By: </div>
					<div id="submitter">Name</div>

					<div id="state-heading">State: </div>
					<div id="state-slot">None</div>				
				</div>
				<div id="challenge-details">Stuff</div>
			</div>
			<div id="controllerB"></div>
		</div>
		<div id="game-list" class="hidden">
			<button id="game-0" onclick="$challenge.loadGame(0);">Game 1</button>
			<button id="game-1" onclick="$challenge.loadGame(1);">Game 2</button>
			<button id="game-2" onclick="$challenge.loadGame(2);">Game 3</button>
			<div id="game-0-overlay"></div>
			<div id="game-1-overlay"></div>
			<div id="game-2-overlay"></div>
			<div id="game-0-name"></div>
			<div id="game-1-name"></div>
			<div id="game-2-name"></div>
			<div id="game-0-console"></div>
			<div id="game-1-console"></div>
			<div id="game-2-console"></div>
			<div id="game-0-channel">TB</div>
			<div id="game-1-channel">TB</div>
			<div id="game-2-channel">TB</div>
		</div>
		
		<p><button id="next" onclick="getNext();">Next</button></p>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="vgc-common.js"></script>
		<script>
			// based on https://github.com/nbrunt/TextFit
			// modified to require a max-height
			function textfit(node) {
				node[0].style["font-size"] = null;
				var fs = parseInt(node.css("font-size"), 10);
				var mh = parseInt(node.css("max-height"), 10);
				while (node[0].scrollHeight > mh) {
					node.css("font-size", --fs + "px");
				}
			};
			
			/* http://stackoverflow.com/a/2450976 */
			function shuffle(array) {
				var currentIndex = array.length, temporaryValue, randomIndex;

				// While there remain elements to shuffle...
				while (0 !== currentIndex) {

					// Pick a remaining element...
					randomIndex = Math.floor(Math.random() * currentIndex);
					currentIndex -= 1;

					// And swap it with the current element.
					temporaryValue = array[currentIndex];
					array[currentIndex] = array[randomIndex];
					array[randomIndex] = temporaryValue;
				}

				return array;
			}

			var isCalled = false;
			function notSeen(value) {
				return !$challenge.seenChallenges.includes(value);
			}
			function getTitleCardUrl(name) {
				var cleanName = name.replace(/[\\\/:*?"<>|]/g,'');
				return "images/titlecards/" + cleanName + ".gif";
			}
			function setImage(jqueryPath) {
				var titleCard = $(jqueryPath);
				var titleImageUrl = getTitleCardUrl(titleCard.text());
				var titleImage = new Image();
				titleCard.removeClass('load-failed');
				titleCard.css("background-image", "");
				titleImage.onload = function() {
					titleCard.css("background-image", 'url("'+titleImageUrl+'")');
				};
				titleImage.onerror = function() {
					titleCard.addClass('load-failed');
				};
				titleImage.src = titleImageUrl;
			}
			$challenge = {
				availableChallenges: [],
				seenChallenges: [],
				activeChallenges: [null,null,null],
				shownChallenge: -1,
				loadChallenges: function (challenges) {
					var filteredChallenges = challenges.filter(isSaveState).filter(isNotOnlyRelay);
					
					$challenge.availableChallenges = [];
					for (var i=0; i<filteredChallenges.length; ++i) {
						var c = filteredChallenges[i];
						c.GameConsole = getConsoleNameForId(c.GameSystem);
						if ($challenge.availableChallenges[c["GameTitle"]] == null) {
							$challenge.availableChallenges[c["GameTitle"]] = [];
						}
						$challenge.availableChallenges[c["GameTitle"]].push(c);
					}
				},
				loadJSON: function (path, callback) {
					var xobj = new XMLHttpRequest();
					xobj.overrideMimeType("application/json");
					xobj.open('GET', path, true);
					xobj.onreadystatechange = function () {
						if (xobj.readyState == 4 && xobj.status == "200") {
							callback(xobj.responseText);
						}
					};
					xobj.send(null);
				},
				init: function (path) {
					if (!isCalled) {
						isCalled = true;
						$challenge.loadJSON(path, function (response) {
							$challenge.loadChallenges(JSON.parse(response));
							$challenge.nextChoices();
						});
					}
				},
				nextChoices: function () {
					$('body').addClass('selectTv');
					$('#frame').addClass('hidden');
					$('#game-list').removeClass('hidden');
					
					var gameNames = shuffle(Object.keys($challenge.availableChallenges));
					
					// game 1
					var gameName0 = gameNames[0];
					var gameChallenges0 = $challenge.availableChallenges[gameName0];
					var challenge0 = gameChallenges0[Math.floor(Math.random() * gameChallenges0.length)];
					$challenge.activeChallenges[0] = challenge0;
					$('#game-0').text(challenge0["GameTitle"]);
					$('#game-0-name').text(challenge0["GameTitle"]);
					$('#game-0-console').text(challenge0["GameConsole"]);
					textfit($('#game-0'));
					
					// game 2
					var gameName1 = gameNames[1];
					var gameChallenges1 = $challenge.availableChallenges[gameName1];
					var challenge1 = gameChallenges1[Math.floor(Math.random() * gameChallenges1.length)];
					$challenge.activeChallenges[1] = challenge1;
					$('#game-1').text(challenge1["GameTitle"]);
					$('#game-1-name').text(challenge1["GameTitle"]);
					$('#game-1-console').text(challenge1["GameConsole"]);
					textfit($('#game-1'));
					
					// game 3
					var gameName2 = gameNames[2];
					var gameChallenges2 = $challenge.availableChallenges[gameName2];
					var challenge2 = gameChallenges2[Math.floor(Math.random() * gameChallenges2.length)];
					$challenge.activeChallenges[2] = challenge2;
					$('#game-2').text(challenge2["GameTitle"]);
					$('#game-2-name').text(challenge2["GameTitle"]);
					$('#game-2-console').text(challenge2["GameConsole"]);
					textfit($('#game-2'));
					
					// handle image
					setImage('#game-0');
					setImage('#game-1');
					setImage('#game-2');
					
					// show selection controls (do like this to allow fade in)
					$('body').addClass('selectTv');
					$('#game-list').removeClass('hidden');
				},
				loadGame: function (i) {
					$challenge.shownChallenge = i;
					var challenge = $challenge.activeChallenges[i];
					if (!challenge)
					{
						$challenge.clearGame();
						return;
					}
					
					$('body').removeClass('selectTv');
					
					$('#frame').removeClass('hidden');
					$('#game-list').addClass('hidden');
					$('#game-name').text(challenge["GameTitle"]);
					$('#challenge').text('T'+challenge.id);
					$('#game-console').text(challenge["GameConsole"]);
					$('#submitter').text(challenge.Submitter);
					$('#challenge-details').text(challenge["ChallengeDetails"]);
					$('#state-slot').text(challenge.StateSlot !== "" ? challenge.StateSlot : "N/A");
					
					var cssClass = 'controller'+challenge["GameConsole"];
					$('#controllerA').addClass(cssClass);
					$('#controllerB').addClass(cssClass);
					
					$challenge.seenChallenges.push(challenge);
					$challenge.availableChallenges[challenge["GameTitle"]].splice($challenge.availableChallenges[challenge["GameTitle"]].indexOf(challenge));
					if ($challenge.availableChallenges[challenge["GameTitle"]].length == 0) {
						delete $challenge.availableChallenges[challenge["GameTitle"]];
					}
					
					// mark as seen on server
					markIdAsSeen(challenge.id);
						
					clearTimeout();
					setTimeout(function () {
						$('#navContent')[0].style.opacity = 0;
					}, 240000);
					var ding = document.getElementById("ding");
					ding.pause();
					ding.currentTime = 0;
					ding.play();
				}
			};
			window.onload = function () {
				$challenge.init('https://arcadepit.net/api/gamebler/allunseenteambattle');
			};
			function getNext() {
				$challenge.nextChoices();
			}
		</script>
	</body>
</html>